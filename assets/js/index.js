// 25.05.2023
// source: @github.com/motebaya/motebaya.github.io
// ajax github api & back to top button
$(function () {
  let show = false;
  let isfetched = false;
  $(window).on("scroll", function () {
    if ($(this).scrollTop() > 300) {
      $(".back-to-top").fadeIn();
    } else {
      $(".back-to-top").fadeOut();
    }

    // AJAX
    const section = $("#menhera-waiting");
    if (
      !show &&
      !isfetched &&
      section.offset().top <= $(window).scrollTop() + $(window).height()
    ) {
      // fetch the repo list, sort top 5 stars count.
      isfetched = true;
      const target = $('div[id="target-api"]');
      $.ajax(`https://api.github.com/users/motebaya/repos`)
        .done(function (res) {
          // console.log(res);
          res
            .sort(function (a, b) {
              return b.stargazers_count - a.stargazers_count;
            })
            .slice(0, 5)
            .forEach((value, index) => {
              var badges = $("<small>").text(
                "created at " + `${new Date(value.created_at).toDateString()}  `
              );

              // fecth the multiple languange, then create the badges :<
              $.get(`${value.languages_url}`)
                .done(function (response) {
                  // console.log(response);
                  Object.keys(response).forEach((v, k) => {
                    var lang = v.toLocaleLowerCase();
                    var badgeType =
                      lang === "ruby"
                        ? "danger"
                        : lang === "python"
                        ? "info"
                        : lang === "shell"
                        ? "success"
                        : lang === "html"
                        ? "secondary"
                        : lang === "javascript"
                        ? "warning"
                        : lang === "php"
                        ? "primary"
                        : lang === "css"
                        ? "info"
                        : "danger";
                    badges.append(
                      $("<span>", {
                        class: `badge badge-${badgeType} mr-1`,
                        text: `${v}`,
                      })
                    );
                  });
                })
                .fail(function (error) {
                  console.log("error");
                });

              // here append element to target div
              target.append(
                $("<a>", {
                  class: "text-dark mt-1",
                  style: "font-size: 23px",
                  href: `${value.html_url}`,
                  target: "_blank",
                  html: $("<i>", {
                    class: "fa fa-link",
                    text: `  ${value.name}`,
                  }),
                }),
                $("<p>", {
                  class: "text-muted font-13 mb-0",
                  text: ` ${value.description}`,
                }),
                $("<div>", {
                  class: "mt-1",
                  html: [
                    $("<i>", {
                      class: "fa fa-star-o mr-4",
                      text: `  ${value.stargazers_count}`,
                    }),
                    $("<i>", {
                      class: "fa fa-code-fork",
                      text: `${value.forks_count}`,
                    }),
                  ],
                }),
                badges
              );

              if (index + 1 !== 5) {
                target.append($("<hr>"));
              }
            });
          // menhera gone ....
          show = true;
          section.hide();
          $(".msg-waiting").hide();

          // append card footer
          target.append(
            $("<div>", {
              class: "card-footer",
              html: $("<p>", {
                class: "text-center",
                html: $("<small>").text(
                  `this card generated by fetching github API with rate limit 60 request /hour, it will always decrease the limit whenever you refresh the page and scrolling to this element :)`
                ),
              }),
            })
          );
        })
        .fail(function (error) {
          console.log("error");
        })
        .always(function () {
          isfetched = false;
        });
    }
  });

  $(".back-to-top").on("click", function () {
    $("html, body").animate({ scrollTop: 0 }, 600);
    return false;
  });
});
